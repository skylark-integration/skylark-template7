/**
 * skylark-utils-templating - The skylark template engine library.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.1
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx/types","skylark-langx/objects","skylark-langx/Evented","./templating","./helpers/each","./helpers/if","./helpers/join","./helpers/js","./helpers/js_compare","./helpers/partial","./helpers/unless","./helpers/with"],function(e,r,n,i,a,l,s,p,f,h,o,c){"use strict";function u(e){var t,r,n,i=e.replace(/[{}#}]/g,"").split(" "),a=[];for(r=0;r<i.length;r++){var l=i[r];if(0===r)a.push(l);else if(0===l.indexOf('"'))if(2===l.match(/"/g).length)a.push(l);else{for(t=0,n=r+1;n<i.length;n++)if(l+=" "+i[n],i[n].indexOf('"')>=0){t=n,a.push(l);break}t&&(r=t)}else if(l.indexOf("=")>0){var s=l.split("="),p=s[0],f=s[1];if(2!==f.match(/"/g).length){for(t=0,n=r+1;n<i.length;n++)if(f+=" "+i[n],i[n].indexOf('"')>=0){t=n;break}t&&(r=t)}var h=[p,f.replace(/"/g,"")];a.push(h)}else a.push(l)}return a}function d(t){var r,n,i=[];if(!t)return[];var a=t.split(/({{[^{^}]*}})/);for(r=0;r<a.length;r++){var l=a[r];if(""!==l)if(l.indexOf("{{")<0)i.push({type:"plain",content:l});else{if(l.indexOf("{/")>=0)continue;if(l.indexOf("{#")<0&&l.indexOf(" ")<0&&l.indexOf("else")<0){i.push({type:"variable",contextName:l.replace(/[{}]/g,"")});continue}var s=u(l),p=s[0],f=">"===p,h=[],o={};for(n=1;n<s.length;n++){var c=s[n];e.isArray(c)?o[c[0]]="false"!==c[1]&&c[1]:h.push(c)}if(l.indexOf("{#")>=0){var d,g="",v="",x=0,m=!1,O=!1,y=0;for(n=r+1;n<a.length;n++)if(a[n].indexOf("{{#")>=0&&y++,a[n].indexOf("{{/")>=0&&y--,a[n].indexOf("{{#"+p)>=0)g+=a[n],O&&(v+=a[n]),x++;else if(a[n].indexOf("{{/"+p)>=0){if(!(x>0)){d=n,m=!0;break}x--,g+=a[n],O&&(v+=a[n])}else a[n].indexOf("else")>=0&&0===y?O=!0:(O||(g+=a[n]),O&&(v+=a[n]));m&&(d&&(r=d),i.push({type:"helper",helperName:p,contextName:h,content:g,inverseContent:v,hash:o}))}else l.indexOf(" ")>0&&(f&&(p="partial",h[0]&&(0===h[0].indexOf("[")?h[0]=h[0].replace(/[[\]]/g,""):h[0]=h[0].replace(/"|'/g,""))),i.push({type:"helper",helperName:p,contextName:h,hash:o}))}}return i}var g=n.inherit({klassName:"Templater",init:function(e,t){this._options=e||{},this._helpers=r.mixin({each:a,"if":l,join:s,js:p,js_compare:f,partial:h,unless:o,"with":c},t),this._partials={},this._cache={}},compile:function(e){function r(e,t){return e.content?l(e.content,t):function(){return""}}function n(e,t){return e.inverseContent?l(e.inverseContent,t):function(){return""}}function i(e,t){var r,n,i=0;if(0===e.indexOf("../")){i=e.split("../").length-1;var a=t.split("_")[1]-i;t="ctx_"+(a>=1?a:1),n=e.split("../")[i].split(".")}else 0===e.indexOf("@global")?(t="$.Template7.global",n=e.split("@global.")[1].split(".")):0===e.indexOf("@root")?(t="ctx_1",n=e.split("@root.")[1].split(".")):n=e.split(".");r=t;for(var l=0;l<n.length;l++){var s=n[l];0===s.indexOf("@")?l>0?r+="[(data && data."+s.replace("@","")+")]":r="(data && data."+e.replace("@","")+")":isFinite(s)?r+="["+s+"]":0===s.indexOf("this")?r=s.replace("this",t):r+="."+s}return r}function a(e,t){for(var r=[],n=0;n<e.length;n++)0===e[n].indexOf('"')?r.push(e[n]):r.push(i(e[n],t));return r.join(", ")}function l(e,l){if(l=l||1,e=e||t.template,"string"!=typeof e)throw new Error("Template7: Template must be a string");var p=d(e);if(0===p.length)return function(){return""};var f="ctx_"+l,h="(function ("+f+", data) {\n";1===l&&(h+=f+".templater = this\n",h+="function isArray(arr){return Object.prototype.toString.apply(arr) === '[object Array]';}\n",h+="function isFunction(func){return (typeof func === 'function');}\n",h+='function c(val, ctx) {if (typeof val !== "undefined") {if (isFunction(val)) {return val.call(ctx);} else return val;} else return "";}\n'),h+="var r = '';\n";var o;for(o=0;o<p.length;o++){var c=p[o];if("plain"!==c.type){var u,g;if("variable"===c.type&&(u=i(c.contextName,f),h+="r += c("+u+", "+f+");"),"helper"===c.type)if(c.helperName in s._helpers)g=a(c.contextName,f),h+="r += "+f+".templater._helpers."+c.helperName+".call("+f+", "+(g&&g+", ")+"{hash:"+JSON.stringify(c.hash)+", data: data || {}, fn: "+r(c,l+1)+", inverse: "+n(c,l+1)+", root: ctx_1});";else{if(c.contextName.length>0)throw new Error('Missing helper: "'+c.helperName+'"');u=i(c.helperName,f),h+="if ("+u+") {",h+="if (isArray("+u+")) {",h+="r += "+f+".templater._helpers.each.call("+f+", "+u+", {hash:"+JSON.stringify(c.hash)+", data: data || {}, fn: "+r(c,l+1)+", inverse: "+n(c,l+1)+", root: ctx_1});",h+="}else {",h+="r += "+f+".templater._helpers.with.call("+f+", "+u+", {hash:"+JSON.stringify(c.hash)+", data: data || {}, fn: "+r(c,l+1)+", inverse: "+n(c,l+1)+", root: ctx_1});",h+="}}"}}else h+="r +='"+c.content.replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/'/g,"\\'")+"';"}return h+="\nreturn r;})",eval.call(window,h)}var s=this,p=this._cache[e];if(!p){var f=l(e);p=this._cache[e]=function(){return f.apply(s,arguments)}}return p},render:function(e,t){var r=this.compile(e);return r(t)},registerHelper:function(e,t){this._helpers[e]=t},unregisterHelper:function(e){this._helpers[e]=void 0,delete this._helpers[e]},registerPartial:function(e,t){this._partials[e]={template:t}},unregisterPartial:function(e){this._partials[e]&&(this._partials[e]=void 0,delete this._partials[e])}}),v=g.defaultTemplater=new g;return["registerHelper","registerPartial","unregisterHelper","unregisterPartial","render","compile"].forEach(function(e){i[e]=function(){return g.prototype[e].apply(v,arguments)}}),i.Templater=g});
//# sourceMappingURL=sourcemaps/Templater.js.map
