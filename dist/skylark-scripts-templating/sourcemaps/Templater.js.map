{"version":3,"sources":["Templater.js"],"names":["define","types","objects","Evented","templating","eachHelper","ifHelper","joinHelper","jsHelper","jsCompareHelper","partialHelper","unlessHelper","withHelper","helperToSlices","string","shiftIndex","i","j","helperParts","replace","split","slices","length","part","push","indexOf","match","hashParts","hashName","hashContent","hash","Templater","inherit","klassName","init","options","helpers","this","_options","_helpers","mixin","each","if","join","js","js_compare","partial","unless","with","_partials","_cache","compile","template","templater","getCompileFn","block","depth","content","getCompileInverse","inverseContent","getCompileVar","name","ctx","variable","parts","levelsUp","newDepth","isFinite","getCompiledArguments","contextArray","arr","t","Error","blocks","_blocks","type","contextName","helperSlices","helperName","isPartial","helperContext","helperHash","slice","isArray","helperContent","elseContent","toSkip","foundClosed","foundElse","stringToBlocks","resultString","compiledArguments","JSON","stringify","eval","call","window","compiled","fn","apply","arguments","render","data","registerHelper","unregisterHelper","undefined","registerPartial","unregisterPartial","defaultTemplater","forEach","prototype"],"mappings":";;;;;;;AAAAA,QACE,sBACA,wBACA,wBACA,eACA,iBACA,eACA,iBACA,eACA,uBACA,oBACA,mBACA,kBACA,SACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,GAEA,aAGA,SAASC,EAAeC,GACtB,IAEIC,EAAYC,EAAGC,EAFfC,EAAcJ,EAAOK,QAAQ,UAAW,IAAIC,MAAM,KAClDC,KAEJ,IAAKL,EAAI,EAAGA,EAAIE,EAAYI,OAAQN,IAAK,CACvC,IAAIO,EAAOL,EAAYF,GACvB,GAAU,IAANA,EAASK,EAAOG,KAAKD,QAEvB,GAA0B,IAAtBA,EAAKE,QAAQ,KAEf,GAAgC,IAA5BF,EAAKG,MAAM,MAAMJ,OAEnBD,EAAOG,KAAKD,OAET,CAGH,IADAR,EAAa,EACRE,EAAID,EAAI,EAAGC,EAAIC,EAAYI,OAAQL,IAEtC,GADAM,GAAQ,IAAML,EAAYD,GACtBC,EAAYD,GAAGQ,QAAQ,MAAQ,EAAG,CACpCV,EAAaE,EACbI,EAAOG,KAAKD,GACZ,MAGAR,IAAYC,EAAID,QAItB,GAAIQ,EAAKE,QAAQ,KAAO,EAAG,CAEzB,IAAIE,EAAYJ,EAAKH,MAAM,KACvBQ,EAAWD,EAAU,GACrBE,EAAcF,EAAU,GAC5B,GAAuC,IAAnCE,EAAYH,MAAM,MAAMJ,OAAc,CAExC,IADAP,EAAa,EACRE,EAAID,EAAI,EAAGC,EAAIC,EAAYI,OAAQL,IAEtC,GADAY,GAAe,IAAMX,EAAYD,GAC7BC,EAAYD,GAAGQ,QAAQ,MAAQ,EAAG,CACpCV,EAAaE,EACb,MAGAF,IAAYC,EAAID,GAEtB,IAAIe,GAAQF,EAAUC,EAAYV,QAAQ,KAAK,KAC/CE,EAAOG,KAAKM,QAIZT,EAAOG,KAAKD,GAKpB,OAAOF,EAwHT,IAAIU,EAAY5B,EAAQ6B,SACtBC,UAAY,YAEZC,KAAO,SAASC,EAAQC,GACtBC,KAAKC,SAAWH,MAChBE,KAAKE,SAAWrC,EAAQsC,OACtBC,KAASpC,EACTqC,GAAOpC,EACPqC,KAASpC,EACTqC,GAAOpC,EACPqC,WAAepC,EACfqC,QAAYpC,EACZqC,OAAWpC,EACXqC,KAASpC,GACTwB,GAEFC,KAAKY,aACLZ,KAAKa,WAGPC,QAAU,SAASC,GACjB,IAAIC,EAAYhB,KAEhB,SAASiB,EAAaC,EAAOC,GAC3B,OAAID,EAAME,QAAgBN,EAAQI,EAAME,QAASD,GACrC,WAAa,MAAO,IAElC,SAASE,EAAkBH,EAAOC,GAChC,OAAID,EAAMI,eAAuBR,EAAQI,EAAMI,eAAgBH,GACnD,WAAa,MAAO,IAElC,SAASI,EAAcC,EAAMC,GAC3B,IAAIC,EAAUC,EAAOC,EAAW,EAChC,GAA4B,IAAxBJ,EAAKpC,QAAQ,OAAc,CAC7BwC,EAAWJ,EAAKzC,MAAM,OAAOE,OAAS,EACtC,IAAI4C,EAAWJ,EAAI1C,MAAM,KAAK,GAAK6C,EACnCH,EAAM,QAAUI,GAAY,EAAIA,EAAW,GAC3CF,EAAQH,EAAKzC,MAAM,OAAO6C,GAAU7C,MAAM,UAEP,IAA5ByC,EAAKpC,QAAQ,YACpBqC,EAAM,qBACNE,EAAQH,EAAKzC,MAAM,YAAY,GAAGA,MAAM,MAEP,IAA1ByC,EAAKpC,QAAQ,UACpBqC,EAAM,QACNE,EAAQH,EAAKzC,MAAM,UAAU,GAAGA,MAAM,MAGtC4C,EAAQH,EAAKzC,MAAM,KAErB2C,EAAWD,EACX,IAAK,IAAI9C,EAAI,EAAGA,EAAIgD,EAAM1C,OAAQN,IAAK,CACrC,IAAIO,EAAOyC,EAAMhD,GACS,IAAtBO,EAAKE,QAAQ,KACXT,EAAI,EACN+C,GAAY,kBAAoBxC,EAAKJ,QAAQ,IAAK,IAAM,KAGxD4C,EAAW,iBAAmBF,EAAK1C,QAAQ,IAAK,IAAM,IAIpDgD,SAAS5C,GACXwC,GAAY,IAAMxC,EAAO,IAGI,IAAzBA,EAAKE,QAAQ,QACfsC,EAAWxC,EAAKJ,QAAQ,OAAQ2C,GAGhCC,GAAY,IAAMxC,EAM1B,OAAOwC,EAET,SAASK,EAAqBC,EAAcP,GAE1C,IADA,IAAIQ,KACKtD,EAAI,EAAGA,EAAIqD,EAAa/C,OAAQN,IACF,IAAjCqD,EAAarD,GAAGS,QAAQ,KAAY6C,EAAI9C,KAAK6C,EAAarD,IAE5DsD,EAAI9C,KAAKoC,EAAcS,EAAarD,GAAI8C,IAG5C,OAAOQ,EAAI3B,KAAK,MAElB,SAASQ,EAAQC,EAAUI,GAGzB,GAFAA,EAAQA,GAAS,EAEO,iBADxBJ,EAAWA,GAAYmB,EAAEnB,UAEvB,MAAM,IAAIoB,MAAM,wCAElB,IAAIC,EApNV,SAAwB3D,GACtB,IAAiBE,EAAGC,EAAhBwD,KACJ,IAAK3D,EAAQ,SACb,IAAI4D,EAAU5D,EAAOM,MAAM,iBAC3B,IAAKJ,EAAI,EAAGA,EAAI0D,EAAQpD,OAAQN,IAAK,CACnC,IAAIuC,EAAQmB,EAAQ1D,GACpB,GAAc,KAAVuC,EACJ,GAAIA,EAAM9B,QAAQ,MAAQ,EACxBgD,EAAOjD,MACLmD,KAAM,QACNlB,QAASF,QAEN,CACL,GAAIA,EAAM9B,QAAQ,OAAS,EACzB,SAEF,GAAI8B,EAAM9B,QAAQ,MAAQ,GAAK8B,EAAM9B,QAAQ,KAAO,GAAK8B,EAAM9B,QAAQ,QAAU,EAAG,CAElFgD,EAAOjD,MACLmD,KAAM,WACNC,YAAarB,EAAMpC,QAAQ,QAAS,MAEtC,SAGF,IAAI0D,EAAehE,EAAe0C,GAC9BuB,EAAaD,EAAa,GAC1BE,EAA2B,MAAfD,EACZE,KACAC,KACJ,IAAKhE,EAAI,EAAGA,EAAI4D,EAAavD,OAAQL,IAAK,CACxC,IAAIiE,EAAQL,EAAa5D,GACrBhB,EAAMkF,QAAQD,GAEhBD,EAAWC,EAAM,IAAmB,UAAbA,EAAM,IAAyBA,EAAM,GAG5DF,EAAcxD,KAAK0D,GAIvB,GAAI3B,EAAM9B,QAAQ,OAAS,EAAG,CAE5B,IAIIV,EAHAqE,EAAgB,GAChBC,EAAc,GACdC,EAAS,EAETC,GAAc,EAAOC,GAAY,EAAgChC,EAAQ,EAC7E,IAAKvC,EAAID,EAAI,EAAGC,EAAIyD,EAAQpD,OAAQL,IAOlC,GANIyD,EAAQzD,GAAGQ,QAAQ,QAAU,GAC/B+B,IAEEkB,EAAQzD,GAAGQ,QAAQ,QAAU,GAC/B+B,IAEEkB,EAAQzD,GAAGQ,QAAQ,MAAQqD,IAAe,EAC5CM,GAAiBV,EAAQzD,GACrBuE,IAAWH,GAAeX,EAAQzD,IACtCqE,SAEG,GAAIZ,EAAQzD,GAAGQ,QAAQ,MAAQqD,IAAe,EAAG,CACpD,KAAIQ,EAAS,GAKR,CACHvE,EAAaE,EACbsE,GAAc,EACd,MAPAD,IACAF,GAAiBV,EAAQzD,GACrBuE,IAAWH,GAAeX,EAAQzD,SAQjCyD,EAAQzD,GAAGQ,QAAQ,SAAW,GAAe,IAAV+B,EAC1CgC,GAAY,GAGPA,IAAWJ,GAAiBV,EAAQzD,IACrCuE,IAAWH,GAAeX,EAAQzD,KAItCsE,IACExE,IAAYC,EAAID,GACpB0D,EAAOjD,MACLmD,KAAM,SACNG,WAAYA,EACZF,YAAaI,EACbvB,QAAS2B,EACTzB,eAAgB0B,EAChBvD,KAAMmD,UAGD1B,EAAM9B,QAAQ,KAAO,IAC1BsD,IACFD,EAAa,UACTE,EAAc,KACsB,IAAlCA,EAAc,GAAGvD,QAAQ,KAC3BuD,EAAc,GAAKA,EAAc,GAAG7D,QAAQ,SAAU,IAEtD6D,EAAc,GAAKA,EAAc,GAAG7D,QAAQ,OAAQ,MAK1DsD,EAAOjD,MACLmD,KAAM,SACNG,WAAYA,EACZF,YAAaI,EACblD,KAAMmD,MAKd,OAAOR,EAkGUgB,CAAerC,GAC5B,GAAsB,IAAlBqB,EAAOnD,OACT,OAAO,WAAc,MAAO,IAE9B,IASIN,EATA8C,EAAM,OAASN,EACfkC,EAAe,cAAgB5B,EAAM,cASzC,IARc,IAAVN,IACFkC,GAAgB5B,EAAM,sBACtB4B,GAAgB,6FAChBA,GAAgB,oEAChBA,GAAgB,4IAElBA,GAAgB,gBAEX1E,EAAI,EAAGA,EAAIyD,EAAOnD,OAAQN,IAAK,CAClC,IAMI+C,EAAU4B,EANVpC,EAAQkB,EAAOzD,GAEnB,GAAmB,UAAfuC,EAAMoB,MAWV,GALmB,aAAfpB,EAAMoB,OAERe,GAAgB,WADhB3B,EAAWH,EAAcL,EAAMqB,YAAad,IACL,KAAOA,EAAM,MAGnC,WAAfP,EAAMoB,KACR,GAAIpB,EAAMuB,cAAczB,EAAUd,SAChCoD,EAAoBvB,EAAqBb,EAAMqB,YAAad,GAC5D4B,GAAgB,QAAS5B,EAAM,uBAAyBP,EAAMuB,WAAa,SAAWhB,EAAM,MAAS6B,GAAsBA,EAAoB,MAAQ,SAAWC,KAAKC,UAAUtC,EAAMzB,MAAQ,2BAA6BwB,EAAaC,EAAOC,EAAM,GAAK,cAAgBE,EAAkBH,EAAOC,EAAM,GAAK,uBAE5S,CACH,GAAID,EAAMqB,YAAYtD,OAAS,EAC7B,MAAM,IAAIkD,MAAM,oBAAsBjB,EAAMuB,WAAa,KAGzDY,GAAgB,QADhB3B,EAAWH,EAAcL,EAAMuB,WAAYhB,IACP,MACpC4B,GAAgB,eAAiB3B,EAAW,OAC5C2B,GAAgB,QAAS5B,EAAM,iCAAmCA,EAAM,KAAQC,EAAW,WAAa6B,KAAKC,UAAUtC,EAAMzB,MAAQ,2BAA6BwB,EAAaC,EAAOC,EAAM,GAAK,cAAgBE,EAAkBH,EAAOC,EAAM,GAAK,mBACrPkC,GAAgB,UAChBA,GAAgB,QAAS5B,EAAM,iCAAmCA,EAAM,KAAQC,EAAW,WAAa6B,KAAKC,UAAUtC,EAAMzB,MAAQ,2BAA6BwB,EAAaC,EAAOC,EAAM,GAAK,cAAgBE,EAAkBH,EAAOC,EAAM,GAAK,mBACrPkC,GAAgB,WAzBpBA,GAAgB,QAAYnC,EAAa,QAAEpC,QAAQ,MAAO,OAAOA,QAAQ,MAAO,OAAOA,QAAQ,KAAM,OAAe,KA+BxH,OADAuE,GAAgB,gBACTI,KAAKC,KAAKC,OAAQN,GAG3B,IAAIO,EAAW5D,KAAKa,OAAOE,GAC3B,IAAK6C,EAAU,CACb,IAAIC,EAAK/C,EAAQC,GACjB6C,EAAW5D,KAAKa,OAAOE,GAAY,WACjC,OAAO8C,EAAGC,MAAM9C,EAAU+C,YAG9B,OAAOH,GAGTI,OAAS,SAASjD,EAASkD,GAEzB,OADejE,KAAKc,QAAQC,EACrB6C,CAASK,IAGlBC,eAAiB,SAAU1C,EAAMqC,GAC/B7D,KAAKE,SAASsB,GAAQqC,GAGxBM,iBAAmB,SAAU3C,GAC3BxB,KAAKE,SAASsB,QAAQ4C,SACfpE,KAAKE,SAASsB,IAGvB6C,gBAAkB,SAAU7C,EAAMT,GAChCf,KAAKY,UAAUY,IACbT,SAAaA,IAIjBuD,kBAAoB,SAAU9C,GACxBxB,KAAKY,UAAUY,KACjBxB,KAAKY,UAAUY,QAAQ4C,SAChBpE,KAAKY,UAAUY,OAOxB+C,EAAmB7E,EAAU6E,iBAAmB,IAAI7E,EAexD,OAZE,iBACA,kBACA,mBACA,oBACA,SACA,WACA8E,QAAQ,SAASX,GACjB9F,EAAW8F,GAAM,WACf,OAAOnE,EAAU+E,UAAUZ,GAAIC,MAAMS,EAAiBR,cAInDhG,EAAW2B,UAAYA","file":"../Templater.js","sourcesContent":["define([\r\n  \"skylark-langx/types\",\r\n  \"skylark-langx/objects\",\r\n  \"skylark-langx/Evented\",\r\n  \"./templating\",\r\n  \"./helpers/each\",\r\n  \"./helpers/if\",\r\n  \"./helpers/join\",\r\n  \"./helpers/js\",\r\n  \"./helpers/js_compare\",\r\n  \"./helpers/partial\",\r\n  \"./helpers/unless\",\r\n  \"./helpers/with\"\r\n],function(\r\n  types, \r\n  objects, \r\n  Evented, \r\n  templating,\r\n  eachHelper, \r\n  ifHelper,\r\n  joinHelper,\r\n  jsHelper,\r\n  jsCompareHelper,\r\n  partialHelper,\r\n  unlessHelper,\r\n  withHelper){\r\n\r\n  \"use strict\";\r\n\r\n  var cache = {};\r\n  function helperToSlices(string) {\r\n    var helperParts = string.replace(/[{}#}]/g, '').split(' ');\r\n    var slices = [];\r\n    var shiftIndex, i, j;\r\n    for (i = 0; i < helperParts.length; i++) {\r\n      var part = helperParts[i];\r\n      if (i === 0) slices.push(part);\r\n      else {\r\n        if (part.indexOf('\"') === 0) {\r\n          // Plain String\r\n          if (part.match(/\"/g).length === 2) {\r\n            // One word string\r\n            slices.push(part);\r\n          }\r\n          else {\r\n            // Find closed Index\r\n            shiftIndex = 0;\r\n            for (j = i + 1; j < helperParts.length; j++) {\r\n              part += ' ' + helperParts[j];\r\n              if (helperParts[j].indexOf('\"') >= 0) {\r\n                shiftIndex = j;\r\n                slices.push(part);\r\n                break;\r\n              }\r\n            }\r\n            if (shiftIndex) i = shiftIndex;\r\n          }\r\n        }\r\n        else {\r\n          if (part.indexOf('=') > 0) {\r\n            // Hash\r\n            var hashParts = part.split('=');\r\n            var hashName = hashParts[0];\r\n            var hashContent = hashParts[1];\r\n            if (hashContent.match(/\"/g).length !== 2) {\r\n              shiftIndex = 0;\r\n              for (j = i + 1; j < helperParts.length; j++) {\r\n                hashContent += ' ' + helperParts[j];\r\n                if (helperParts[j].indexOf('\"') >= 0) {\r\n                  shiftIndex = j;\r\n                  break;\r\n                }\r\n              }\r\n              if (shiftIndex) i = shiftIndex;\r\n            }\r\n            var hash = [hashName, hashContent.replace(/\"/g,'')];\r\n            slices.push(hash);\r\n          }\r\n          else {\r\n            // Plain variable\r\n            slices.push(part);\r\n          }\r\n        }\r\n      }\r\n    }\r\n    return slices;\r\n  }\r\n  function stringToBlocks(string) {\r\n    var blocks = [], i, j, k;\r\n    if (!string) return [];\r\n    var _blocks = string.split(/({{[^{^}]*}})/);\r\n    for (i = 0; i < _blocks.length; i++) {\r\n      var block = _blocks[i];\r\n      if (block === '') continue;\r\n      if (block.indexOf('{{') < 0) {\r\n        blocks.push({\r\n          type: 'plain',\r\n          content: block\r\n        });\r\n      } else {\r\n        if (block.indexOf('{/') >= 0) {\r\n          continue;\r\n        }\r\n        if (block.indexOf('{#') < 0 && block.indexOf(' ') < 0 && block.indexOf('else') < 0) {\r\n          // Simple variable\r\n          blocks.push({\r\n            type: 'variable',\r\n            contextName: block.replace(/[{}]/g, '')\r\n          });\r\n          continue;\r\n        }\r\n        // Helpers\r\n        var helperSlices = helperToSlices(block);\r\n        var helperName = helperSlices[0];\r\n        var isPartial = helperName === '>';\r\n        var helperContext = [];\r\n        var helperHash = {};\r\n        for (j = 1; j < helperSlices.length; j++) {\r\n          var slice = helperSlices[j];\r\n          if (types.isArray(slice)) {\r\n            // Hash\r\n            helperHash[slice[0]] = slice[1] === 'false' ? false : slice[1];\r\n          }\r\n          else {\r\n            helperContext.push(slice);\r\n          }\r\n        }\r\n\r\n        if (block.indexOf('{#') >= 0) {\r\n          // Condition/Helper\r\n          var helperStartIndex = i;\r\n          var helperContent = '';\r\n          var elseContent = '';\r\n          var toSkip = 0;\r\n          var shiftIndex;\r\n          var foundClosed = false, foundElse = false, foundClosedElse = false, depth = 0;\r\n          for (j = i + 1; j < _blocks.length; j++) {\r\n            if (_blocks[j].indexOf('{{#') >= 0) {\r\n              depth ++;\r\n            }\r\n            if (_blocks[j].indexOf('{{/') >= 0) {\r\n              depth --;\r\n            }\r\n            if (_blocks[j].indexOf('{{#' + helperName) >= 0) {\r\n              helperContent += _blocks[j];\r\n              if (foundElse) elseContent += _blocks[j];\r\n              toSkip ++;\r\n            }\r\n            else if (_blocks[j].indexOf('{{/' + helperName) >= 0) {\r\n              if (toSkip > 0) {\r\n                toSkip--;\r\n                helperContent += _blocks[j];\r\n                if (foundElse) elseContent += _blocks[j];\r\n              }\r\n              else {\r\n                shiftIndex = j;\r\n                foundClosed = true;\r\n                break;\r\n              }\r\n            }\r\n            else if (_blocks[j].indexOf('else') >= 0 && depth === 0) {\r\n              foundElse = true;\r\n            }\r\n            else {\r\n              if (!foundElse) helperContent += _blocks[j];\r\n              if (foundElse) elseContent += _blocks[j];\r\n            }\r\n\r\n          }\r\n          if (foundClosed) {\r\n            if (shiftIndex) i = shiftIndex;\r\n            blocks.push({\r\n              type: 'helper',\r\n              helperName: helperName,\r\n              contextName: helperContext,\r\n              content: helperContent,\r\n              inverseContent: elseContent,\r\n              hash: helperHash\r\n            });\r\n          }\r\n        } else if (block.indexOf(' ') > 0) {\r\n          if (isPartial) {\r\n            helperName = 'partial';\r\n            if (helperContext[0]) {\r\n              if (helperContext[0].indexOf('[') === 0) {\r\n                helperContext[0] = helperContext[0].replace(/[[\\]]/g, '');\r\n              } else {\r\n                helperContext[0] = helperContext[0].replace(/\"|'/g, '');\r\n              }\r\n            }\r\n          }\r\n\r\n          blocks.push({\r\n            type: 'helper',\r\n            helperName: helperName,\r\n            contextName: helperContext,\r\n            hash: helperHash\r\n          });\r\n        }\r\n      }\r\n    }\r\n    return blocks;\r\n  }\r\n\r\n\r\n  var Templater = Evented.inherit({\r\n    klassName : \"Templater\",\r\n\r\n    init : function(options,helpers) {\r\n      this._options = options || {};\r\n      this._helpers = objects.mixin({\r\n        \"each\" : eachHelper,\r\n        \"if\" : ifHelper,\r\n        \"join\" : joinHelper,\r\n        \"js\" : jsHelper,\r\n        \"js_compare\" : jsCompareHelper,\r\n        \"partial\" : partialHelper,\r\n        \"unless\" : unlessHelper,\r\n        \"with\" : withHelper,\r\n      },helpers);\r\n\r\n      this._partials = {};\r\n      this._cache = {};\r\n\r\n    },\r\n    compile : function(template) {\r\n      var templater = this;\r\n\r\n      function getCompileFn(block, depth) {\r\n        if (block.content) return compile(block.content, depth);\r\n        else return function () {return ''; };\r\n      }\r\n      function getCompileInverse(block, depth) {\r\n        if (block.inverseContent) return compile(block.inverseContent, depth);\r\n        else return function () {return ''; };\r\n      }\r\n      function getCompileVar(name, ctx) {\r\n        var variable, parts, levelsUp = 0, initialCtx = ctx;\r\n        if (name.indexOf('../') === 0) {\r\n          levelsUp = name.split('../').length - 1;\r\n          var newDepth = ctx.split('_')[1] - levelsUp;\r\n          ctx = 'ctx_' + (newDepth >= 1 ? newDepth : 1);\r\n          parts = name.split('../')[levelsUp].split('.');\r\n        }\r\n        else if (name.indexOf('@global') === 0) {\r\n          ctx = '$.Template7.global';\r\n          parts = name.split('@global.')[1].split('.');\r\n        }\r\n        else if (name.indexOf('@root') === 0) {\r\n          ctx = 'ctx_1';\r\n          parts = name.split('@root.')[1].split('.');\r\n        }\r\n        else {\r\n          parts = name.split('.');\r\n        }\r\n        variable = ctx;\r\n        for (var i = 0; i < parts.length; i++) {\r\n          var part = parts[i];\r\n          if (part.indexOf('@') === 0) {\r\n            if (i > 0) {\r\n              variable += '[(data && data.' + part.replace('@', '') + ')]';\r\n            }\r\n            else {\r\n              variable = '(data && data.' + name.replace('@', '') + ')';\r\n            }\r\n          }\r\n          else {\r\n            if (isFinite(part)) {\r\n              variable += '[' + part + ']';\r\n            }\r\n            else {\r\n              if (part.indexOf('this') === 0) {\r\n                variable = part.replace('this', ctx);\r\n              }\r\n              else {\r\n                variable += '.' + part;       \r\n              }\r\n            }\r\n          }\r\n        }\r\n\r\n        return variable;\r\n      }\r\n      function getCompiledArguments(contextArray, ctx) {\r\n        var arr = [];\r\n        for (var i = 0; i < contextArray.length; i++) {\r\n          if (contextArray[i].indexOf('\"') === 0) arr.push(contextArray[i]);\r\n          else {\r\n            arr.push(getCompileVar(contextArray[i], ctx));\r\n          }\r\n        }\r\n        return arr.join(', ');\r\n      }\r\n      function compile(template, depth) {\r\n        depth = depth || 1;\r\n        template = template || t.template;\r\n        if (typeof template !== 'string') {\r\n          throw new Error('Template7: Template must be a string');\r\n        }\r\n        var blocks = stringToBlocks(template);\r\n        if (blocks.length === 0) {\r\n          return function () { return ''; };\r\n        }\r\n        var ctx = 'ctx_' + depth;\r\n        var resultString = '(function (' + ctx + ', data) {\\n';\r\n        if (depth === 1) {\r\n          resultString += ctx + '.templater = this\\n';\r\n          resultString += 'function isArray(arr){return Object.prototype.toString.apply(arr) === \\'[object Array]\\';}\\n';\r\n          resultString += 'function isFunction(func){return (typeof func === \\'function\\');}\\n';\r\n          resultString += 'function c(val, ctx) {if (typeof val !== \"undefined\") {if (isFunction(val)) {return val.call(ctx);} else return val;} else return \"\";}\\n';\r\n        }\r\n        resultString += 'var r = \\'\\';\\n';\r\n        var i, j, context;\r\n        for (i = 0; i < blocks.length; i++) {\r\n          var block = blocks[i];\r\n          // Plain block\r\n          if (block.type === 'plain') {\r\n            resultString += 'r +=\\'' + (block.content).replace(/\\r/g, '\\\\r').replace(/\\n/g, '\\\\n').replace(/'/g, '\\\\' + '\\'') + '\\';';\r\n            continue;\r\n          }\r\n          var variable, compiledArguments;\r\n          // Variable block\r\n          if (block.type === 'variable') {\r\n            variable = getCompileVar(block.contextName, ctx);\r\n            resultString += 'r += c(' + variable + ', ' + ctx + ');';\r\n          }\r\n          // Helpers block\r\n          if (block.type === 'helper') {\r\n            if (block.helperName in templater._helpers) {\r\n              compiledArguments = getCompiledArguments(block.contextName, ctx);\r\n              resultString += 'r += '+ ctx + '.templater._helpers.' + block.helperName + '.call(' + ctx + ', '  + (compiledArguments && (compiledArguments + ', ')) +'{hash:' + JSON.stringify(block.hash) + ', data: data || {}, fn: ' + getCompileFn(block, depth+1) + ', inverse: ' + getCompileInverse(block, depth+1) + ', root: ctx_1});';\r\n            }\r\n            else {\r\n              if (block.contextName.length > 0) {\r\n                throw new Error('Missing helper: \"' + block.helperName + '\"');\r\n              } else {\r\n                variable = getCompileVar(block.helperName, ctx);\r\n                resultString += 'if (' + variable + ') {';\r\n                resultString += 'if (isArray(' + variable + ')) {';\r\n                resultString += 'r += '+ ctx + '.templater._helpers.each.call(' + ctx + ', '  + variable + ', {hash:' + JSON.stringify(block.hash) + ', data: data || {}, fn: ' + getCompileFn(block, depth+1) + ', inverse: ' + getCompileInverse(block, depth+1) + ', root: ctx_1});';\r\n                resultString += '}else {';\r\n                resultString += 'r += '+ ctx + '.templater._helpers.with.call(' + ctx + ', '  + variable + ', {hash:' + JSON.stringify(block.hash) + ', data: data || {}, fn: ' + getCompileFn(block, depth+1) + ', inverse: ' + getCompileInverse(block, depth+1) + ', root: ctx_1});';\r\n                resultString += '}}';\r\n              }\r\n            }\r\n          }\r\n        }\r\n        resultString += '\\nreturn r;})';\r\n        return eval.call(window, resultString);\r\n      }\r\n\r\n      var compiled = this._cache[template];\r\n      if (!compiled) {\r\n        var fn = compile(template);\r\n        compiled = this._cache[template] = function(){\r\n          return fn.apply(templater,arguments);\r\n        };\r\n      }\r\n      return compiled;\r\n    },\r\n\r\n    render : function(template,data) {\r\n      var compiled = this.compile(template);\r\n      return compiled(data);\r\n    },\r\n\r\n    registerHelper : function (name, fn) {\r\n      this._helpers[name] = fn;\r\n    },\r\n    \r\n    unregisterHelper : function (name) {\r\n      this._helpers[name] = undefined;  \r\n      delete this._helpers[name];\r\n    },\r\n\r\n    registerPartial : function (name, template) {\r\n      this._partials[name] = { \r\n        \"template\" : template \r\n      };\r\n    },\r\n\r\n    unregisterPartial : function (name) {\r\n      if (this._partials[name]) {\r\n        this._partials[name] = undefined;\r\n        delete this._partials[name];\r\n      }\r\n    }\r\n\r\n\r\n  });\r\n\r\n  var defaultTemplater = Templater.defaultTemplater = new Templater();\r\n\r\n  [\r\n    \"registerHelper\",\r\n    \"registerPartial\",\r\n    \"unregisterHelper\",\r\n    \"unregisterPartial\",\r\n    \"render\",\r\n    \"compile\"\r\n  ].forEach(function(fn){\r\n    templating[fn] = function() {\r\n      return Templater.prototype[fn].apply(defaultTemplater,arguments);\r\n    }\r\n  });\r\n\r\n  return templating.Templater = Templater;\r\n});\r\n\r\n"]}