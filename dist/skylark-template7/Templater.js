/**
 * skylark-template7 - A version of template7.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx/types","skylark-langx/objects","skylark-langx/Evented","./templating","./helpers/each","./helpers/if","./helpers/join","./helpers/js","./helpers/js_compare","./helpers/partial","./helpers/unless","./helpers/with"],function(e,r,n,i,a,l,s,p,f,h,o,c){"use strict";function u(e){var t,r,n,i=e.replace(/[{}#}]/g,"").split(" "),a=[];for(r=0;r<i.length;r++){var l=i[r];if(0===r)a.push(l);else if(0===l.indexOf('"'))if(2===l.match(/"/g).length)a.push(l);else{for(t=0,n=r+1;n<i.length;n++)if(l+=" "+i[n],i[n].indexOf('"')>=0){t=n,a.push(l);break}t&&(r=t)}else if(l.indexOf("=")>0){var s=l.split("="),p=s[0],f=s[1];if(2!==f.match(/"/g).length){for(t=0,n=r+1;n<i.length;n++)if(f+=" "+i[n],i[n].indexOf('"')>=0){t=n;break}t&&(r=t)}var h=[p,f.replace(/"/g,"")];a.push(h)}else a.push(l)}return a}var d=n.inherit({klassName:"Templater",init:function(e,t){this._options=e||{},this._helpers=r.mixin({each:a,if:l,join:s,js:p,js_compare:f,partial:h,unless:o,with:c},t),this._partials={},this._cache={}},compile:function(r){var n=this;function i(e,t){return e.content?p(e.content,t):function(){return""}}function a(e,t){return e.inverseContent?p(e.inverseContent,t):function(){return""}}function l(e,t){var r,n,i=0;if(0===e.indexOf("../")){i=e.split("../").length-1;var a=t.split("_")[1]-i;t="ctx_"+(a>=1?a:1),n=e.split("../")[i].split(".")}else 0===e.indexOf("@global")?(t="$.Template7.global",n=e.split("@global.")[1].split(".")):0===e.indexOf("@root")?(t="ctx_1",n=e.split("@root.")[1].split(".")):n=e.split(".");r=t;for(var l=0;l<n.length;l++){var s=n[l];0===s.indexOf("@")?l>0?r+="[(data && data."+s.replace("@","")+")]":r="(data && data."+e.replace("@","")+")":isFinite(s)?r+="["+s+"]":0===s.indexOf("this")?r=s.replace("this",t):r+="."+s}return r}function s(e,t){for(var r=[],n=0;n<e.length;n++)0===e[n].indexOf('"')?r.push(e[n]):r.push(l(e[n],t));return r.join(", ")}function p(r,p){if(p=p||1,"string"!=typeof(r=r||t.template))throw new Error("Template7: Template must be a string");var f=function(t){var r,n,i=[];if(!t)return[];var a=t.split(/({{[^{^}]*}})/);for(r=0;r<a.length;r++){var l=a[r];if(""!==l)if(l.indexOf("{{")<0)i.push({type:"plain",content:l});else{if(l.indexOf("{/")>=0)continue;if(l.indexOf("{#")<0&&l.indexOf(" ")<0&&l.indexOf("else")<0){i.push({type:"variable",contextName:l.replace(/[{}]/g,"")});continue}var s=u(l),p=s[0],f=">"===p,h=[],o={};for(n=1;n<s.length;n++){var c=s[n];e.isArray(c)?o[c[0]]="false"!==c[1]&&c[1]:h.push(c)}if(l.indexOf("{#")>=0){var d,g="",x="",v=0,m=!1,O=!1,y=0;for(n=r+1;n<a.length;n++)if(a[n].indexOf("{{#")>=0&&y++,a[n].indexOf("{{/")>=0&&y--,a[n].indexOf("{{#"+p)>=0)g+=a[n],O&&(x+=a[n]),v++;else if(a[n].indexOf("{{/"+p)>=0){if(!(v>0)){d=n,m=!0;break}v--,g+=a[n],O&&(x+=a[n])}else a[n].indexOf("else")>=0&&0===y?O=!0:(O||(g+=a[n]),O&&(x+=a[n]));m&&(d&&(r=d),i.push({type:"helper",helperName:p,contextName:h,content:g,inverseContent:x,hash:o}))}else l.indexOf(" ")>0&&(f&&(p="partial",h[0]&&(0===h[0].indexOf("[")?h[0]=h[0].replace(/[[\]]/g,""):h[0]=h[0].replace(/"|'/g,""))),i.push({type:"helper",helperName:p,contextName:h,hash:o}))}}return i}(r);if(0===f.length)return function(){return""};var h,o="ctx_"+p,c="(function ("+o+", data) {\n";for(1===p&&(c+=o+".templater = this\n",c+="function isArray(arr){return Object.prototype.toString.apply(arr) === '[object Array]';}\n",c+="function isFunction(func){return (typeof func === 'function');}\n",c+='function c(val, ctx) {if (typeof val !== "undefined") {if (isFunction(val)) {return val.call(ctx);} else return val;} else return "";}\n'),c+="var r = '';\n",h=0;h<f.length;h++){var d,g,x=f[h];if("plain"!==x.type){if("variable"===x.type&&(c+="r += c("+(d=l(x.contextName,o))+", "+o+");"),"helper"===x.type)if(x.helperName in n._helpers)g=s(x.contextName,o),c+="r += "+o+".templater._helpers."+x.helperName+".call("+o+", "+(g&&g+", ")+"{hash:"+JSON.stringify(x.hash)+", data: data || {}, fn: "+i(x,p+1)+", inverse: "+a(x,p+1)+", root: ctx_1});";else{if(x.contextName.length>0)throw new Error('Missing helper: "'+x.helperName+'"');c+="if ("+(d=l(x.helperName,o))+") {",c+="if (isArray("+d+")) {",c+="r += "+o+".templater._helpers.each.call("+o+", "+d+", {hash:"+JSON.stringify(x.hash)+", data: data || {}, fn: "+i(x,p+1)+", inverse: "+a(x,p+1)+", root: ctx_1});",c+="}else {",c+="r += "+o+".templater._helpers.with.call("+o+", "+d+", {hash:"+JSON.stringify(x.hash)+", data: data || {}, fn: "+i(x,p+1)+", inverse: "+a(x,p+1)+", root: ctx_1});",c+="}}"}}else c+="r +='"+x.content.replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/'/g,"\\'")+"';"}return c+="\nreturn r;})",eval.call(window,c)}var f=this._cache[r];if(!f){var h=p(r);f=this._cache[r]=function(){return h.apply(n,arguments)}}return f},render:function(e,t){return this.compile(e)(t)},registerHelper:function(e,t){this._helpers[e]=t},unregisterHelper:function(e){this._helpers[e]=void 0,delete this._helpers[e]},registerPartial:function(e,t){this._partials[e]={template:t}},unregisterPartial:function(e){this._partials[e]&&(this._partials[e]=void 0,delete this._partials[e])}}),g=d.defaultTemplater=new d;return["registerHelper","registerPartial","unregisterHelper","unregisterPartial","render","compile"].forEach(function(e){i[e]=function(){return d.prototype[e].apply(g,arguments)}}),i.Templater=d});
//# sourceMappingURL=sourcemaps/Templater.js.map
